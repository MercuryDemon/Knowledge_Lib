27-05-2025 22:30
Tags: #z #lesson #Go 
map - хэш-таблица в Go. [[Хэш-таблица (HashMap)]]
- хранит пары ключ-значение
- запись и чтение элементов имеет временную константную сложность O(1)

```go
// создание пустой мапы
var m map[int]string

// сокращенное создание пустой мапы
m := map[int]string{}

// рекомендуемое создание с обозначением размера
m := make(map[int]string, 10)

// создание мапы с элементами
m := map[int]string{1: "hello", 2: "world"}

// добавление элемента
m[3] = "!" // map[1:hello, 2:world, 3:!]

// чтение элемента
word := m[1] // "hello"
```

Если ключа нет в мапе позваращается ноль заданного типа.


Проверка наличия ключа через "двойное присваивание"
```go
elements := map[int64]bool{1: true, 2: false}

element, elementExists := elements[1] // true, true // значение, наличие элемента(тоже значение по сути)
element, elementExists := elements[2] // false, true
element, elementExists := elements[225] // false, false
```



Удаление элементов через встроенную функцию 

```go 
delete(m map[Type]Type1, key Type
```
       ^     ^      ^       ^
имя мапы   тип      тип     ключ который удаляем
          ключа   значений        и его тип
          в мапе   в мапе

```go
engToRus := map[string]string{"hello":"привет", "world":"мир"}

delete(engToRus, "world")
// функция принимает навход имя мапы и "ключ" в кавычках, который удаляем
fmt.Println(engToRus) // map[hello:привет]
```

Мапы всегда передаются по ссылке. Если мы вносим изменения в мапу внутри области видимости функции, мапа меняется в main().


## map глубоко
- Ячейки внутри мапы разделены на группы(бакеты), для того чтобы сделать поиск по элементам за константное время.

- элементы по бакетам равномерно распределяются хэшфункцией (см. [[Хэш-таблица (HashMap)]])

- Внутри мапы используется unsafe.Pointer то есть указатели которые могут указывать на любой тип данных. 
- Для того чтобы понимать с каким типом данных работает мапа, внутри нее есть дескриптор типа(type descriptor) 
- type descriptor- это структура которая содержит информацию о типе данных и как с ним взаимодействовать
- map type - структура определяющая типы данных  у ключа и значения, а также отвечающая за хэширование (hasher)

## Cтруктура мапы:
![[IMG_20250827_180834.jpg]]
 каждому бакету соответствуют младшие биты хэша(low order bit)
 LOB - помогают искать бакеты из предоставленной хэшфункции.

- lob вычисляются отсатком от деления на колическо бакетов. Операция вычисления остатка от деления выполняется по битово. Хэш ключа переводится в двоичное число после чего берем логарифм по основанию 2 от количества бакетов.
![[Pasted image 20250827180028.png]]
в данном примере 2 бита младшего порядка являются LOB(HASH) = 01

## Структура Бакета
![[Pasted image 20250827202123.png]]

Условно делится на 2 части:
- 8 слотов для higher order bit(старшие биты хэша) - позволяют быстро проверить наличие ключа в бакете
- ключи и значения хранятся в виде списка 


- в каждом бакете может храниться не более 8 значений
- все ключи в начале, все значения в конце - type alignment (выравнивание типов)

## Переполнение бакета

В случае если бакет полон, а в него требуется записать новое значение, тогда создается новый бакет, а ссылка на него сохраняется в изначальном бакете.
![[Pasted image 20250827204557.png]]
КРАЙНЕ НЕЖЕЛАТЕЛЬНО

Новая память под мапу выделяется когда load factor > 6.5 (во всех бакетах в среднем по 6.5 значений из 8 возможных).
- В таком случае происходит Эвакуация данных: создается новая мапа под которую выделенно в 2 раза болоьше памяти, затем все данные из бакетов копируются в новую мапу в другие бакеты распределяясь равномерно.
- память не инициалихируется сразу, операции переноса данных из старой мапы в новую выполняется во время операций сохранения или удаления ключей(инкрементально)
- В момент эвакуации данных операции по поиску ключей будут происходить дольше, так каак ключи будут искаться в обоих мапах

Избежать всего этого хаотичного пиздеца можно лишь одним способом, ЗАРАНЕЕ ВЫДЕЛИТЬ НУЖНОЕ КОЛИЧЕСТВО ПАМЯТИ ДЛЯ МАПЫ



### Zero-Links
- [[00 Golang]]
- [[00 Обучение]]


### Links
- https://ru.hexlet.io/courses/go-basics/lessons/map/theory_unit

